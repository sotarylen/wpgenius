(function(){var d=window.iwArgsImageActions||{},I=Array.isArray(d.allowed_mimes)&&d.allowed_mimes.length?d.allowed_mimes:null,p=function(t,a){return a===void 0&&(a=document),(a||document).querySelector(t)},w=function(t,a){return a===void 0&&(a=document),Array.prototype.slice.call((a||document).querySelectorAll(t))},x=function(t,a){if(!t)return!1;var e=t.matches||t.msMatchesSelector||t.webkitMatchesSelector;return e?e.call(t,a):!1},k=function(t,a){for(var e=t;e;){if(x(e,a))return e;e=e.parentElement}return null},y=function(t){return!!(t&&(t.offsetWidth||t.offsetHeight||t.getClientRects().length))},C=function(){return w(".iw-notice").forEach(function(t){return t.remove()})},E=function(){return w(".iw-overlay").forEach(function(t){return t.remove()})},L=function(t){return Object.keys(t).map(function(a){return encodeURIComponent(a)+"="+encodeURIComponent(t[a])}).join("&")},S=function(t,a){return new Promise(function(e,n){if(window.fetch){window.fetch(t,{method:"POST",credentials:"same-origin",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},body:a}).then(function(o){return o.json()}).then(e).catch(n);return}var r=new XMLHttpRequest;r.open("POST",t,!0),r.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),r.onreadystatechange=function(){if(r.readyState===4)if(r.status>=200&&r.status<300)try{e(JSON.parse(r.responseText))}catch(i){n(i)}else n(new Error("Request failed"))},r.send(a)})},s={running:!1,actionLocation:"",action:"",response:"",selected:[],successCount:0,skippedCount:0,gridButtonsBound:!1,gridFrame:null,gridButtons:[],gridDomInterval:null,attachmentInfoToken:0,isGridSelectModeActive:function(){var t=p(".select-mode-toggle-button");if(t){var a=t.getAttribute("aria-pressed")||t.getAttribute("aria-checked");if(a==="true"||t.classList&&(t.classList.contains("active")||t.classList.contains("is-pressed")))return!0}var e=p(".attachments-browser");if(e&&(e.classList.contains("mode-select")||e.classList.contains("is-attachment-select-mode")||e.classList.contains("select-mode")))return!0;var n=p(".media-frame");return!!(n&&(n.classList.contains("mode-select")||n.classList.contains("select-mode"))||w(".attachments-browser .attachments .attachment.selected").length)},init:function(){document.addEventListener("click",function(t){var a=k(t.target,".bulkactions input#doaction, .bulkactions input#doaction2");if(a){var e=k(a,".bulkactions"),n=e?e.querySelector("select"):null,r=n?n.value:"";if(!(!r||!d.backup_image&&r==="removewatermark")&&(r==="applywatermark"||r==="removewatermark")){if(t.preventDefault(),s.running){s.notice("iw-notice error",d.__running,!1);return}s.running=!0,s.action=r,s.actionLocation="upload-list",s.selected=w('.wp-list-table .check-column input[type="checkbox"]:checked').map(function(o){return o.value}),C(),s.postLoop()}}}),document.addEventListener("click",function(t){var a=k(t.target,".iw-notice.is-dismissible .notice-dismiss");if(a){var e=k(a,".iw-notice");e&&e.remove()}}),this.initGridMode()},initGridMode:function(){var t=this;if(!(this.gridButtonsBound||typeof wp=="undefined"||!wp.media||typeof window.iwArgsMedia=="undefined")){var a=function(i){t.gridButtonsBound=!0,t.gridFrame=i,i.on("ready",t.renderGridButtons),i.on("select:activate",t.renderGridButtons),i.on("select:deactivate",t.hideGridButtons),i.on("selection:toggle selection:action:done library:selection:add",t.updateGridButtonsState),i.on("attachments:selected",t.updateAttachmentInfoActions),i.on("selection:change",t.updateAttachmentInfoActions),i.on("toolbar:render:details",t.updateAttachmentInfoActions),i.on("content:render",t.updateAttachmentInfoActions),t.renderGridButtons(),t.updateAttachmentInfoActions()},e=function(){var i=wp.media&&(wp.media.frame||wp.media.frames&&(wp.media.frames.browse||wp.media.frames.manage));return i&&typeof i.on=="function"?(a(i),!0):!1};if(!e())var n=setInterval(function(){e()&&clearInterval(n)},300);var r=new MutationObserver(function(o){o.forEach(function(i){i.addedNodes.forEach(function(c){c.nodeType===Node.ELEMENT_NODE&&(c.matches(".attachment-info")||c.querySelector(".attachment-info"))&&s.updateAttachmentInfoActions()})})});r.observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("click",function(o){k(o.target,".select-mode-toggle-button")&&(t.renderGridButtons(),t.gridDomInterval&&clearInterval(t.gridDomInterval),t.gridDomInterval=setInterval(function(){t.renderGridButtons()},400),setTimeout(function(){t.gridDomInterval&&(clearInterval(t.gridDomInterval),t.gridDomInterval=null)},3e3))}),document.addEventListener("click",function(o){k(o.target,".attachments-browser .attachment, .attachments-browser .attachment .check")&&setTimeout(t.updateGridButtonsState,50)})}},ensureGridButtonsDom:function(){var t=this;if(p(".media-modal"))return!1;var a=function(){for(var m=[".media-frame.mode-grid .media-frame-toolbar .media-toolbar",".media-frame.mode-grid .media-toolbar",".media-frame .media-frame-toolbar .media-toolbar",".attachments-browser .media-toolbar",".attachments-browser .attachments-filters"],b=0;b<m.length;b++)for(var g=w(m[b]),v=0;v<g.length;v++)if(y(g[v]))return g[v];return null},e=a();if(!e)return!1;var n=(function(){for(var l=w(".media-toolbar-primary",e),m=0;m<l.length;m++)if(y(l[m]))return l[m];for(var b=w(".media-toolbar-secondary",e),g=0;g<b.length;g++)if(y(b[g]))return b[g];return e})();if(!n)return!1;n.style.overflow="visible",w(".iw-grid-watermark-apply, .iw-grid-watermark-remove",n).forEach(function(l){return l.remove()});var r=function(m,b,g){var v=document.createElement("button");return v.type="button",v.className="button media-button "+m,v.textContent=b,v.addEventListener("click",function(){return t.startGridAction(g)}),v},o=(function(){for(var l=w(".select-mode-toggle-button",n),m=0;m<l.length;m++)if(y(l[m]))return l[m];return null})(),i=r("iw-grid-watermark-apply",window.iwArgsMedia.applyWatermark,"applywatermark"),c=o||n.firstChild||null;n.insertBefore(i,c);var h=[i];if(d.backup_image){var f=r("iw-grid-watermark-remove",window.iwArgsMedia.removeWatermark,"removewatermark");n.insertBefore(f,c),h.push(f)}return this.gridButtons=h,this.hideGridButtons(),!0},renderGridButtons:function(){if(s.ensureGridButtonsDom()){if(!s.isGridSelectModeActive()){s.hideGridButtons();return}s.gridButtons.forEach(function(t){t.style.display=""}),s.updateGridButtonsState()}},hideGridButtons:function(){s.gridButtons.forEach(function(t){t.disabled=!0,t.style.display="none"})},updateGridButtonsState:function(){if(s.gridButtons.length){if(!s.isGridSelectModeActive()){s.hideGridButtons();return}var t=s.collectSelectionIds(),a=s.running||t.length===0;s.gridButtons.forEach(function(e){e&&(e.disabled=a||e.classList.contains("iw-grid-watermark-remove")&&!d.backup_image)})}},runAttachmentAction:function(t,a,e){if(!s.running){var n=w(".iw-attachment-action");n.forEach(function(i){return i.classList.add("disabled")}),e&&(e.textContent=d.single_running,e.className="iw-attachment-status");var r=L({_iw_nonce:d._nonce,action:"iw_watermark_bulk_action","iw-action":t,attachment_id:a}),o=function(){n.forEach(function(c){return c.classList.remove("disabled")}),s.running=!1};s.running=!0,S(window.ajaxurl||"/wp-admin/admin-ajax.php",r).then(function(i){if(i&&i.success){var c=t==="applywatermark"?d.single_applied:d.single_removed;e&&(e.textContent=c,e.className="iw-attachment-status success"),s.refreshAttachmentThumb(a)}else e&&(e.textContent=i&&i.data||d.single_error,e.className="iw-attachment-status error")}).catch(function(){e&&(e.textContent=d.single_error,e.className="iw-attachment-status error")}).then(o)}},updateAttachmentInfoActions:function(){w(".media-modal .iw-attachment-action, .media-modal .iw-separator, .media-modal .iw-watermark-setting").forEach(function(c){return c.remove()}),s.attachmentInfoToken+=1;var t=s.attachmentInfoToken,a=p(".media-modal #image_watermark_buttons"),e=s.gridFrame&&s.gridFrame.state?s.gridFrame.state().get("selection"):null,n=e&&e.first?e.first():null,r=function(){return n&&typeof n.get=="function"?n.get("id"):a?a.getAttribute("data-id"):null},o=function(){return n?s.isSupportedModel(n):!0},i=function(h){if(h===void 0&&(h=0),t===s.attachmentInfoToken){var f=p('.media-modal .attachment-details .setting[data-setting="url"]')||p('.media-modal .attachment-info .setting[data-setting="url"]'),l=r();if(!(!l||!o())&&!(f&&k(f,".iw-is-watermark-selector"))){if(!f){h<20&&setTimeout(function(){return i(h+1)},100);return}var m=f.parentElement?f.parentElement.querySelector(".iw-watermark-setting"):null;m||s.injectAttachmentActions(f,l)}}};i()},injectAttachmentActions:function(t,a){if(!(!a||!t)){var e=t.parentElement;if(e){var n=function(v,A,_,T){var B=document.createElement("button");return B.type="button",B.className="button buttons-secondary button-small "+v+" iw-attachment-action",B.textContent=A,B.addEventListener("click",function(){s.actionLocation="media-modal",s.action=_,s.runAttachmentAction(_,a,T)}),B},r=d.apply_label||"Apply watermark",o=d.remove_label||"Remove watermark",i=d.setting_label||"Watermark",c=document.createElement("span");c.className="setting iw-watermark-setting",c.setAttribute("data-setting","iw-watermark");var h=document.createElement("label");h.className="name",h.textContent=i;var f=document.createElement("span");f.className="value iw-attachment-actions";var l=document.createElement("p");l.className="iw-attachment-status",l.setAttribute("aria-live","polite");var m=n("iw-attachment-apply",r,"applywatermark",l);if(f.appendChild(m),d.backup_image){var b=n("iw-attachment-remove",o,"removewatermark",l);f.appendChild(b)}f.appendChild(l),c.appendChild(h),c.appendChild(f),e.insertBefore(c,t.nextSibling)}}},collectSelectionIds:function(){var t=[],a=this.gridFrame;if(a&&typeof a.state=="function"){var e=a.state().get("selection");e&&e.models&&e.models.forEach(function(n){if(s.isSupportedModel(n)){var r=typeof n.get=="function"?n.get("id"):n.id;r&&t.push(r)}})}return t.length||w(".attachments-browser .attachments .attachment.selected").forEach(function(n){if(s.isSupportedDom(n)){var r=n.getAttribute("data-id");r&&t.push(r)}}),t},startGridAction:function(t){var a=this.collectSelectionIds();if(!a.length){this.notice("iw-notice error",d.__running,!1);return}!d.backup_image&&t==="removewatermark"||this.isGridSelectModeActive()&&(this.running=!0,this.action=t,this.actionLocation="grid",this.selected=a.slice(0),C(),this.updateGridButtonsState(),this.postLoop())},postLoop:function(){var t=this;if(!this.selected.length){this.reset();return}var a=this.selected[0],e=Number(a);if(Number.isNaN(e)){this.selected.shift(),this.postLoop();return}this.rowImageFeedback(e),this.actionLocation==="upload-list"&&this.scrollTo("#post-"+e,"bottom");var n=L({_iw_nonce:d._nonce,action:"iw_watermark_bulk_action","iw-action":this.action,attachment_id:e});S(window.ajaxurl||"/wp-admin/admin-ajax.php",n).then(function(r){t.result(r,e)},function(r){t.notice("iw-notice error",r&&r.message||"Request failed",!1),t.rowImageFeedback(e)}).then(function(){t.selected.shift(),t.postLoop();var r=p(".iw-overlay");if(r){var o=p("#image_watermark_buttons .value");if(o&&(t.response==="watermarked"||t.response==="watermarkremoved")){var i=document.createElement("span");i.className="dashicons dashicons-yes",i.style.cssText="font-size:24px;float:none;min-width:28px;padding:0;margin:0;display:none;",o.appendChild(i),i.style.display="",setTimeout(function(){i.remove()},1500)}r.remove()}})},result:function(t,a){if(t&&t.success===!0){var e=!1,n="",r=!0;switch(this.response=t.data,t.data){case"watermarked":e="iw-notice updated iw-watermarked",this.successCount+=1,n=this.successCount>1?d.__applied_multi.replace("%s",this.successCount):d.__applied_one,this.rowImageFeedback(a),this.reloadImage(a),this.refreshAttachmentCache(a);break;case"watermarkremoved":e="iw-notice updated iw-watermarkremoved",this.successCount+=1,n=this.successCount>1?d.__removed_multi.replace("%s",this.successCount):d.__removed_one,this.rowImageFeedback(a),this.reloadImage(a),this.refreshAttachmentCache(a);break;case"skipped":e="iw-notice error iw-skipped",this.skippedCount+=1,n=d.__skipped+": "+this.skippedCount,this.rowImageFeedback(a);break;default:e="iw-notice error iw-message",n=t.data,this.rowImageFeedback(a),r=!1;break}e&&this.notice(e,n,r)}else this.notice("iw-notice error",t?t.data:d.__running,!1),this.rowImageFeedback(a)},rowImageFeedback:function(t){var a="",e={},n={};switch(this.actionLocation){case"upload-list":{a=".wp-list-table #post-"+t+" .media-icon";var r=p(a),o=r?r.getBoundingClientRect():{width:0,height:0};e={display:"table",width:(o.width||0)+"px",height:(o.height||0)+"px",top:"0",left:"0",position:"absolute",font:"normal normal normal dashicons",background:"rgba(255,255,255,0.75)",content:""},n={verticalAlign:"middle",textAlign:"center",display:"table-cell",width:"100%",height:"100%"};break}case"grid":{a='.attachments-browser .attachments [data-id="'+t+'"] .attachment-preview';var i=p(a),c=i?i.getBoundingClientRect():{width:0,height:0};e={display:"table",width:(c.width||0)+"px",height:(c.height||0)+"px",top:"0",left:"0",position:"absolute",font:"normal normal normal dashicons",background:"rgba(255,255,255,0.75)",content:""},n={verticalAlign:"middle",textAlign:"center",display:"table-cell",width:"100%",height:"100%"};break}case"edit":{a=".wp_attachment_holder #thumbnail-head-"+t;var h=p(a+" img"),f=h?h.getBoundingClientRect():{width:0,height:0};e={display:"table",width:(f.width||0)+"px",height:(f.height||0)+"px",top:"0",left:"0",position:"absolute",font:"normal normal normal dashicons",background:"rgba(255,255,255,0.75)",content:""},n={verticalAlign:"middle",textAlign:"center",display:"table-cell",width:"100%",height:"100%"};break}default:return}var l=p(a);if(l){getComputedStyle(l).position==="static"&&(l.style.position="relative");var m=l.querySelector(".iw-overlay");if(!m){m=document.createElement("span"),m.className="iw-overlay";var b=document.createElement("span");b.className="iw-overlay-inner",m.appendChild(b),l.appendChild(m)}for(var g in e)Object.prototype.hasOwnProperty.call(e,g)&&(m.style[g]=e[g]);var v=m.querySelector(".iw-overlay-inner");for(var A in n)Object.prototype.hasOwnProperty.call(n,A)&&(v.style[A]=n[A]);if(v.innerHTML='<span class="spinner is-active"></span>',this.actionLocation==="media-modal"){var _=v.querySelector(".spinner");_&&(_.style.cssText="float:none;padding:0;margin:-4px 0 0 10px;")}}},notice:function(t,a,e){if(this.actionLocation!=="media-modal"){var n=t+" notice is-dismissible",r=this.actionLocation==="upload-list"?".wrap > h1":"#image_watermark_buttons",o=null;if(e===!0){switch(this.response){case"watermarked":o=".iw-notice.iw-watermarked";break;case"watermarkremoved":o=".iw-notice.iw-watermarkremoved";break;case"skipped":o=".iw-notice.iw-skipped";break}if(o){var i=r.charAt(r.length-1)===" "?r:r+" ",c=p(i+o+" > p");if(c){c.innerHTML=a;return}r=this.actionLocation==="upload-list"?".wrap ":"#image_watermark_buttons "}}var h=p(r);if(!(!h||!h.parentElement)){var f=document.createElement("div");f.className=n,f.innerHTML="<p>"+a+'</p><button type="button" class="notice-dismiss"><span class="screen-reader-text">'+d.__dismiss+"</span></button>",h.insertAdjacentElement("afterend",f)}}},reset:function(){this.running=!1,this.action="",this.response="",this.selected=[],this.successCount=0,this.skippedCount=0,setTimeout(E,100),this.updateGridButtonsState()},reloadImage:function(t){var a=this,e=Date.now(),n=[];switch(this.actionLocation){case"upload-list":n.push(".wp-list-table #post-"+t+" .image-icon img");break;case"grid":n.push('.attachments-browser .attachments [data-id="'+t+'"] img'),n.push('.attachment-details[data-id="'+t+'"] img, .attachment[data-id="'+t+'"] img, .attachment-info .thumbnail img, .attachment-media-view img');break;case"media-modal":n.push('.attachment-details[data-id="'+t+'"] img, .attachment[data-id="'+t+'"] img, .attachment-info .thumbnail img, .attachment-media-view img');break;case"edit":n.push(".attachment-info .thumbnail img, .attachment-media-view img, .wp_attachment_holder img");break}var r=n.filter(Boolean);r.length&&w(r.join(",")).forEach(function(o){o.removeAttribute("srcset"),o.removeAttribute("sizes");var i=o.getAttribute("src")||"";o.setAttribute("src",a.replaceUrlParam(i,"t",e))})},isSupportedModel:function(t){if(!t)return!1;var a=typeof t.get=="function"?t.get("type"):t.type,e=(typeof t.get=="function"?t.get("mime"):t.mime)||(a&&typeof t.get=="function"&&t.get("subtype")?a+"/"+t.get("subtype"):"");return a!=="image"&&(!e||e.indexOf("image/")!==0)?!1:I?I.indexOf(e)!==-1:!0},isSupportedDom:function(t){if(!t)return!1;var a=t.getAttribute("data-type")||"",e=t.getAttribute("data-subtype")||"",n=a&&e?a+"/"+e:"";return a!=="image"&&(!n||n.indexOf("image/")!==0)?!1:I?I.indexOf(n)!==-1:!0},refreshAttachmentCache:function(t){if(!(typeof wp=="undefined"||!wp.media||!wp.media.attachment)){var a=wp.media.attachment(t);a&&a.fetch({cache:!1}).then(function(){s.cacheBustAttachmentSources(a)})}},cacheBustAttachmentSources:function(t){var a=this;if(!(!t||typeof t.get!="function")){var e=Date.now(),n={};if(t.get("url")&&(n.url=this.replaceUrlParam(t.get("url"),"t",e)),t.get("sizes")){var r=t.get("sizes"),o={};Object.keys(r).forEach(function(i){var c=r[i];if(c&&c.url){var h={};Object.keys(c).forEach(function(f){h[f]=c[f]}),h.url=a.replaceUrlParam(c.url,"t",e),o[i]=h}else o[i]=c}),n.sizes=o}t.get("icon")&&(n.icon=this.replaceUrlParam(t.get("icon"),"t",e)),Object.keys(n).length&&t.set(n)}},replaceUrlParam:function(t,a,e){var n=new RegExp("\\b("+a+"=).*?(&|$)");return n.test(t)?t.replace(n,"$1"+e+"$2"):""+t+(t.indexOf("?")>0?"&":"?")+a+"="+e},scrollTo:function(t,a){var e=p(t);if(e){var n=e.getBoundingClientRect(),r=n.top+window.pageYOffset,o=window.pageYOffset,i=o+window.innerHeight,c=r;if(n.top+window.pageYOffset<o)c=r;else if(a==="bottom"){if(n.top+window.pageYOffset<i)return;c=r-window.innerHeight+n.height}else if(a==="center"){if(r<i&&r>=o)return;c=r-window.innerHeight/2+n.height/2}window.scrollTo(0,c)}},refreshAttachmentThumb:function(t){var a=[".attachment-info .thumbnail img",".attachment-media-view img",'.attachment-details[data-id="'+t+'"] img','.attachment[data-id="'+t+'"] img'],e=Date.now();w(a.join(",")).forEach(function(n){var r=n.getAttribute("src")||"";n.removeAttribute("srcset"),n.removeAttribute("sizes"),n.setAttribute("src",s.replaceUrlParam(r,"t",e))})}};window.watermarkImageActions=s,typeof window!="undefined"&&(window.iw=window.iw||{},window.iw.imageActions=Object.assign(window.iw.imageActions||{},{qs:p,qsa:w,matches:x,closest:k,isVisible:y,clearNotices:C,removeOverlays:E,encodeForm:L,requestJson:S,api:s})),typeof d._nonce!="undefined"&&document.addEventListener("DOMContentLoaded",function(){return s.init()})})();
